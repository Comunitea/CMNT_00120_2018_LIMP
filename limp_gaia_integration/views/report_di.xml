<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <report id="report_gaia_di_input"
            name="limp_gaia_integration.template_gaia_input_di"
            string="DI (Gaia)"
            report_type="qweb-xml"
            model="stock.service.picking"/>

    <report id="report_gaia_di_output"
            name="limp_gaia_integration.template_gaia_output_di"
            string="DI (Gaia)"
            report_type="qweb-xml"
            model="stock.picking"/>

     <template id="di_input_header">
        &lt;ns2:e3l schemaVersion="3.0" xmlns:ns2="e3l://eterproject.org/3.0/e3l"&gt;
        <header>
            <test t-esc="company.gaia_test and 'S' or 'N'"/>
            <prepared t-esc="time.strftime('%Y-%m-%dT%H:%M:%S')"/>
            <sender>
                <NIF t-esc="picking.producer_promoter_id and picking.producer_promoter_id.vat.replace('ES', '') or picking.partner_id.vat.replace('ES', '')"/>
                <center t-att-centerCode="picking.producer_promoter_id and picking.producer_promoter_id.nima_no or picking.partner_id.nima_no" t-att-centerDenomination="picking.producer_promoter_id and picking.producer_promoter_id.name or picking.partner_id.name"/>
            </sender>
        </header>
        <t t-raw="0"/>
        &lt;/ns2:e3l&gt;
    </template>

    <template id="di_output_header">
        &lt;ns2:e3l schemaVersion="3.0" xmlns:ns2="e3l://eterproject.org/3.0/e3l"&gt;
        <header>
            <test t-esc="company.gaia_test and 'S' or 'N'"/>
            <prepared t-esc="time.strftime('%Y-%m-%dT%H:%M:%S')"/>
            <sender>
                <NIF t-esc="picking.picking_type_id.warehouse_id.partner_id.vat.replace('ES', '')"/>
                <center t-att-centerCode="picking.picking_type_id.warehouse_id.partner_id.nima_no" t-att-centerDenomination="picking.picking_type_id.warehouse_id.partner_id.name"/>
            </sender>
        </header>
        <t t-raw="0"/>
        &lt;/ns2:e3l&gt;
    </template>

    <template id="entity_data">
        <entityId>
            <nationalId t-esc="partner.commercial_partner_id.vat.replace('ES', '')"/>
        </entityId>
        <entityFJ t-att-entityFJCode="'J' if partner.commercial_partner_id.vat and partner.commercial_partner_id.is_company else 'F'"/>
        <entityName>
            <reason>
                <reasonName t-esc="partner.commercial_partner_id.name"/>
                <reasonAssociation t-att-associationCode="partner.commercial_partner_id.association_type"/>
            </reason>
        </entityName>
        <entityCommercialName t-if="partner.commercial_partner_id.comercial" t-esc="partner.commercial_partner_id.comercial"/>
        <entityCenter>
            <centerID t-att-centerCode="partner.nima_no" t-att-centerDenomination="partner.name"/>
            <centerEconomicActivity t-esc="partner.commercial_partner_id.nace_id and partner.commercial_partner_id.nace_id.code or 'N/A'"/>
            <centerAddress>
                <spanishAddress>
                    <vial t-if="partner.vialType" t-att-vialCode="partner.vialType"/>
                    <address t-esc="partner.street"/>
                    <CP t-esc="partner.zip"/>
                    <municipality t-att-municipalityCode="partner.council_id.ine_code" t-att-municipalityName="partner.council_id.name"/>
                    <province t-att-provinceCode="partner.state_id.code" t-att-provinceName="partner.state_id.name"/>
                    <CA t-if="partner.region_id" t-att-CACode="partner.region_id.code" t-att-CAName="partner.region_id.name"/>
                    <country t-if="partner.country_id" t-att-countryCode="partner.country_id.code_numeric" t-att-countryName="partner.country_id.name"/>
                </spanishAddress>
            </centerAddress>
            <centerContact>
                <phone t-esc="partner.phone"/>
                <phone t-if="partner.mobile" t-esc="partner.mobile"/>
                <fax t-if="partner.fax" t-esc="partner.fax"/>
                <mail t-esc="partner.email"/>
            </centerContact>
            <wasteCenterAuthorization>
                <authorizationId>
                    <authorizationIdFree t-if="picking._name == 'stock.service.picking' and not partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).other_state" t-esc="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).name"/>
                    <authorizationIdEffects t-if="picking._name == 'stock.service.picking' and partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).other_state" t-esc="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).other_state"/>
                    <authorizationIdFree t-if="picking._name == 'stock.picking' and not partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).other_state" t-esc="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).name"/>
                    <authorizationIdEffects t-if="picking._name == 'stock.picking' and partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).other_state" t-esc="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).other_state"/>
                </authorizationId>
                <authorizationCode t-if="picking._name == 'stock.service.picking'" t-esc="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                <authorizationCode t-if="picking._name == 'stock.picking'" t-esc="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
            </wasteCenterAuthorization>
        </entityCenter>
    </template>

    <template id="di_input_waste">
        <waste>
            <wasteDCS t-att-DCSCode="picking.dcs_no" t-att-DCSPhase="picking.dcs_phase" t-att-DCSYear="picking.retired_date.strftime('%Y+01:00')" t-att-DCSDate="picking.retired_date.strftime('%Y-%m-%d+01:00')" t-att-DCSStartDate="min(picking.service_ids.mapped('transport_date')).strftime('%Y-%m-%d+01:00')" t-att-DCSEndDate="max(picking.service_ids.mapped('transport_date')).strftime('%Y-%m-%d+01:00')" DCSRegional="S" DCSSendtoOriginOrDestinationAuthority="N">
                <DCSTransferOperatorData>
                    <t t-set="partner" t-value="picking.operator_partner_id"/>
                    <t t-set="auth_types" t-value="['N']"/>
                    <t t-call="limp_gaia_integration.entity_data"/>
                    <wasteTransferOperatorType t-att-operatorTypeCode="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                </DCSTransferOperatorData>
                <DCSProducerData>
                    <t t-set="partner" t-value="picking.producer_promoter_id or picking.building_site_id.producer_promoter_id"/>
                    <t t-set="auth_types" t-value="['P', 'G']"/>
                    <t t-call="limp_gaia_integration.entity_data"/>
                    <wasteProducerType t-att-producerTypeCode="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    <operator t-if="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type[0] == 'G'">
                        <t t-set="partner" t-value="picking.producer_promoter_id or picking.building_site_id.producer_promoter_id"/>
                        <t t-set="auth_types" t-value="['E']"/>
                        <t t-call="limp_gaia_integration.entity_data"/>
                        <wasteOperatorType t-att-operatorTypeCode="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    </operator>
                </DCSProducerData>
                <DCSAdresseeData>
                    <t t-set="partner" t-value="picking.manager_partner_id"/>
                    <t t-set="auth_types" t-value="['G']"/>
                    <t t-call="limp_gaia_integration.entity_data"/>
                    <wasteManagerType t-att-managerTypeCode="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    <operator>
                        <t t-set="partner" t-value="picking.manager_partner_id"/>
                        <t t-set="auth_types" t-value="['E']"/>
                        <t t-call="limp_gaia_integration.entity_data"/>
                        <wasteOperatorType t-att-operatorTypeCode="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    </operator>
                </DCSAdresseeData>
                <t t-foreach="picking.service_picking_valorization_ids" t-as="waste">
                    <DCSResidueData>
                        <t t-if="waste.product_id.ler_code_id.dangerous">
                            <DCSProducerResidueIdentification xsi:type="ns4:dangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesDangerousType">
                                    <table2 t-esc="waste.operation_type or waste.product_id.ler_code_id.operation_type"/>
                                    <table5 t-esc="waste.product_id.ler_code_id.dangerous_motive"/>
                                </residueTables>
                            </DCSProducerResidueIdentification>
                            <DCSAdresseeResidueIdentification xsi:type="ns4:dangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesDangerousType">
                                    <table2 t-esc="waste.operation_type or waste.product_id.ler_code_id.operation_type"/>
                                    <table5 t-esc="waste.product_id.ler_code_id.dangerous_motive"/>
                                </residueTables>
                            </DCSAdresseeResidueIdentification>
                        </t>
                        <t t-if="not waste.product_id.ler_code_id.dangerous">
                            <DCSProducerResidueIdentification xsi:type="ns4:noDangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesNoDangerousType">
                                    <table2 t-esc="waste.operation_type or waste.product_id.ler_code_id.operation_type"/>
                                </residueTables>
                            </DCSProducerResidueIdentification>
                            <DCSAdresseeResidueIdentification xsi:type="ns4:noDangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesNoDangerousType">
                                    <table2 t-esc="waste.operation_type or waste.product_id.ler_code_id.operation_type"/>
                                </residueTables>
                            </DCSAdresseeResidueIdentification>
                        </t>
                        <DCSOtherResidueData>
                            <DCSDA>DA99999999999999999999999</DCSDA>
                            <DCSNT t-esc="picking.nt_doc_id.name or 'NT99999999999999999999999'"/>
                            <DCSClearWeight t-esc="waste.net_weight * 1000"/>
                            <DCSVolume t-esc="waste.volume"/>
                        </DCSOtherResidueData>
                        <DCSTransporterData>
                            <t t-set="partner" t-value="picking.carrier_id"/>
                            <t t-set="auth_types" t-value="['T']"/>
                            <t t-call="limp_gaia_integration.entity_data"/>
                            <wasteTransporterType t-att-trasporterTypeCode="partner.get_authorization_id(picking.service_picking_valorization_ids.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                            <DCSTransportWay transportWayCode="03"/>
                        </DCSTransporterData>
                        <DCSAcceptanceData t-if="picking.manager_partner_id.commercial_partner_id == company.partner_id">
                            <DCSRealQuantity t-esc="waste.net_weight * 1000"/>
                            <DCSAcceptance>03</DCSAcceptance>
                            <DCSAcceptanceDate t-esc="picking.retired_date.strftime('%Y-%m-%d+01:00')"/>
                            <DCSDeliveryDate t-esc="picking.retired_date.strftime('%Y-%m-%d+01:00')"/>
                        </DCSAcceptanceData>
                    </DCSResidueData>
                </t>
            </wasteDCS>
        </waste>
    </template>

    <template id="di_output_waste">
        <waste>
            <wasteDCS t-att-DCSCode="picking.dcs_no" DCSPhase="D" t-att-DCSYear="picking.date.strftime('%Y+01:00')" t-att-DCSDate="picking.date.strftime('%Y-%m-%d+01:00')" t-att-DCSStartDate="picking.date.strftime('%Y-%m-%d+01:00')" t-att-DCSEndDate="picking.date.strftime('%Y-%m-%d+01:00')" DCSRegional="S" DCSSendtoOriginOrDestinationAuthority="N">
                <DCSTransferOperatorData>
                    <t t-set="partner" t-value="picking.operator_partner_id"/>
                    <t t-set="auth_types" t-value="['N']"/>
                    <t t-call="limp_gaia_integration.entity_data"/>
                    <wasteTransferOperatorType t-att-operatorTypeCode="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                </DCSTransferOperatorData>
                <DCSProducerData>
                    <t t-set="partner" t-value="picking.picking_type_id.warehouse_id.partner_id"/>
                    <t t-set="auth_types" t-value="['P', 'G']"/>
                    <t t-call="limp_gaia_integration.entity_data"/>
                    <wasteProducerType t-att-producerTypeCode="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    <operator t-if="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type[0] == 'G'">
                        <t t-set="partner" t-value="picking.picking_type_id.warehouse_id.partner_id"/>
                        <t t-set="auth_types" t-value="['E']"/>
                        <t t-call="limp_gaia_integration.entity_data"/>
                        <wasteOperatorType t-att-operatorTypeCode="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    </operator>
                </DCSProducerData>
                <DCSAdresseeData>
                    <t t-set="partner" t-value="picking.partner_id"/>
                    <t t-set="auth_types" t-value="['G']"/>
                    <t t-call="limp_gaia_integration.entity_data"/>
                    <wasteManagerType t-att-managerTypeCode="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    <operator>
                        <t t-set="partner" t-value="picking.partner_id"/>
                        <t t-set="auth_types" t-value="['E']"/>
                        <t t-call="limp_gaia_integration.entity_data"/>
                        <wasteOperatorType t-att-operatorTypeCode="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                    </operator>
                </DCSAdresseeData>
                <t t-foreach="picking.move_lines" t-as="waste">
                    <DCSResidueData>
                        <t t-if="waste.product_id.ler_code_id.dangerous">
                            <DCSProducerResidueIdentification xsi:type="ns4:dangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.product_id.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesDangerousType">
                                    <table2 t-esc="waste.product_id.ler_code_id.operation_type"/>
                                    <table5 t-esc="waste.product_id.ler_code_id.dangerous_motive"/>
                                </residueTables>
                            </DCSProducerResidueIdentification>
                            <DCSAdresseeResidueIdentification xsi:type="ns4:dangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.product_id.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesDangerousType">
                                    <table2 t-esc="waste.product_id.ler_code_id.operation_type"/>
                                    <table5 t-esc="waste.product_id.ler_code_id.dangerous_motive"/>
                                </residueTables>
                            </DCSAdresseeResidueIdentification>
                        </t>
                        <t t-if="not waste.product_id.ler_code_id.dangerous">
                            <DCSProducerResidueIdentification xsi:type="ns4:noDangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.product_id.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesNoDangerousType">
                                    <table2 t-esc="waste.product_id.ler_code_id.operation_type"/>
                                </residueTables>
                            </DCSProducerResidueIdentification>
                            <DCSAdresseeResidueIdentification xsi:type="ns4:noDangerousResidueType" t-att-LERCode="waste.product_id.ler_code_id.code" xmlns:ns4="e3l://eterproject.org/3.0/wasteSupport" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                <residueBag>
                                    <bagProcess internalIdProcessCode="99"/>
                                    <bagResidueId residueCode="999" t-att-residueDescription="waste.product_id.name"/>
                                </residueBag>
                                <residueTables xsi:type="ns4:tablesNoDangerousType">
                                    <table2 t-esc="waste.product_id.ler_code_id.operation_type"/>
                                </residueTables>
                            </DCSAdresseeResidueIdentification>
                        </t>
                        <DCSOtherResidueData>
                            <DCSDA>DA99999999999999999999999</DCSDA>
                            <DCSNT t-esc="picking.nt_doc_id.name or 'NT99999999999999999999999'"/>
                            <DCSClearWeight t-esc="waste.secondary_uom_qty * 1000"/>
                            <DCSVolume t-esc="waste.product_uom_qty"/>
                        </DCSOtherResidueData>
                        <DCSTransporterData>
                            <t t-set="partner" t-value="picking.carrier_id"/>
                            <t t-set="auth_types" t-value="['T']"/>
                            <t t-call="limp_gaia_integration.entity_data"/>
                            <wasteTransporterType t-att-trasporterTypeCode="partner.get_authorization_id(picking.move_lines.mapped('product_id.ler_code_id'), auth_types).authorization_type"/>
                            <DCSTransportWay transportWayCode="03"/>
                        </DCSTransporterData>
                        <DCSAcceptanceData>
                            <DCSRealQuantity t-esc="waste.secondary_uom_qty * 1000"/>
                            <DCSAcceptance>03</DCSAcceptance>
                            <DCSAcceptanceDate t-esc="picking.date.strftime('%Y-%m-%d+01:00')"/>
                            <DCSDeliveryDate t-esc="picking.date.strftime('%Y-%m-%d+01:00')"/>
                        </DCSAcceptanceData>
                    </DCSResidueData>
                </t>
            </wasteDCS>
        </waste>
    </template>

    <template id="template_gaia_input_di">
        <t t-call="limp_gaia_integration.di_input_header">
            <t t-set="picking" t-value="docs[0]"/>
            <t t-set="company" t-value="picking.company_id"/>
            <t t-call="limp_gaia_integration.di_input_waste"/>
        </t>
    </template>

    <template id="template_gaia_output_di">
        <t t-call="limp_gaia_integration.di_output_header">
            <t t-set="picking" t-value="docs[0]"/>
            <t t-set="company" t-value="picking.company_id"/>
            <t t-call="limp_gaia_integration.di_output_waste"/>
        </t>
    </template>

</odoo>
